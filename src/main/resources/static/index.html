<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>DevSns</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#4f46e5' }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

<!-- ================= AUTH SCREEN ================= -->
<div id="auth-screen" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200 relative">
        <button onclick="closeAuth()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">âœ•</button>
        <h1 class="text-3xl font-bold text-center mb-8 text-brand tracking-tight">DevSns</h1>

        <div id="login-form" class="space-y-5">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ì´ë©”ì¼</label>
                <input type="email" id="login-email" class="w-full border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand focus:border-brand outline-none transition" placeholder="example@email.com">
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="login-pw" class="w-full border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand focus:border-brand outline-none transition" placeholder="******">
            </div>
            <button id="btn-login" class="w-full bg-brand text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition shadow-lg shadow-indigo-200">ë¡œê·¸ì¸</button>
            <div class="text-center text-sm text-slate-500 mt-4">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button class="text-brand font-semibold hover:underline" onclick="toggleAuthMode()">íšŒì›ê°€ì…</button>
            </div>
        </div>

        <div id="signup-form" class="hidden space-y-5">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ë‹‰ë„¤ì„</label>
                <input type="text" id="signup-nick" class="w-full border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand focus:border-brand outline-none transition" placeholder="Display Name">
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ì´ë©”ì¼</label>
                <input type="email" id="signup-email" class="w-full border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand focus:border-brand outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-1">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                <input type="password" id="signup-pw" class="w-full border border-slate-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-brand focus:border-brand outline-none transition">
            </div>
            <button id="btn-signup" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg">ê°€ì…í•˜ê¸°</button>
            <div class="text-center text-sm text-slate-500 mt-4">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button class="text-brand font-semibold hover:underline" onclick="toggleAuthMode()">ë¡œê·¸ì¸</button>
            </div>
        </div>
        <p id="auth-msg" class="text-center text-rose-500 text-sm mt-4 min-h-[1.25rem] font-medium"></p>
    </div>
</div>

<!-- ================= APP SCREEN ================= -->
<div id="app-screen" class="hidden min-h-screen pb-20">
    <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <div class="h-8 w-8 rounded-lg bg-brand text-white flex items-center justify-center font-bold shadow-md shadow-indigo-200">D</div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">DevSns</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="btn-feed-all" class="text-xs font-medium text-slate-500 hover:text-slate-800 px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-slate-50 transition">ì „ì²´ í”¼ë“œ</button>
                <button id="btn-mypage" class="hidden text-xs font-medium text-slate-600 hover:text-slate-900 px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-slate-50 transition">ë§ˆì´í˜ì´ì§€</button>
                <button id="btn-login-open" class="text-xs font-medium text-brand px-3 py-1.5 border border-indigo-100 rounded-lg hover:bg-indigo-50 transition">ë¡œê·¸ì¸</button>
                <button id="btn-logout" class="hidden text-xs font-medium text-slate-500 hover:text-slate-800 px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-slate-50 transition">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-6 space-y-6">
        <!-- New Post -->
        <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 transition-all focus-within:ring-2 focus-within:ring-brand/20">
            <div class="flex gap-3">
                <div class="h-10 w-10 rounded-full bg-slate-100 shrink-0 flex items-center justify-center text-xl shadow-inner">âœï¸</div>
                <div class="flex-1 space-y-3">
                    <textarea id="new-post-content" class="w-full border-none focus:ring-0 text-base resize-none p-2 placeholder:text-slate-400 bg-transparent" rows="2" placeholder="ë¬´ìŠ¨ ìƒê°ì„ í•˜ê³  ê³„ì‹ ê°€ìš”?"></textarea>
                    <div class="flex justify-end border-t border-slate-100 pt-3">
                        <button id="btn-create-post" class="bg-brand text-white rounded-xl px-5 py-2 text-sm font-bold hover:bg-indigo-600 transition shadow-md shadow-indigo-100">ê²Œì‹œí•˜ê¸°</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Feed List -->
        <section id="feed-container" class="space-y-5"></section>

        <div id="feed-loading" class="hidden text-center py-6">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-100 border-r-brand align-[-0.125em]"></div>
        </div>
        <div id="feed-end" class="hidden text-center text-slate-400 text-sm py-8 font-medium">ëª¨ë“  í¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤ ğŸ‰</div>
    </main>
</div>

<!-- ================= DRAWER ================= -->
<div id="drawer" class="fixed inset-0 z-30 hidden transition-opacity duration-300">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" id="drawer-backdrop"></div>
    <aside class="absolute right-0 top-0 h-full w-full md:w-[500px] bg-white shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-0">
        <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between bg-white/95 backdrop-blur z-10 sticky top-0">
            <h3 class="font-bold text-lg text-slate-800">í¬ìŠ¤íŠ¸ ìƒì„¸</h3>
            <button id="drawer-close" class="text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-full p-2 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar" id="drawer-body">
            <article id="drawer-post" class="space-y-4"></article>
            <div class="h-px bg-slate-100 my-2"></div>
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-bold text-slate-800">ëŒ“ê¸€ <span id="drawer-comment-count" class="text-brand ml-1">0</span></h4>
                </div>
                <div id="comments-list" class="space-y-5"></div>
                <button id="btn-load-more-comments" class="hidden w-full py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 rounded-xl mt-2 transition">ëŒ“ê¸€ ë”ë³´ê¸°</button>
            </section>
        </div>

        <div class="p-4 border-t border-slate-100 bg-white sticky bottom-0">
            <div class="flex gap-2 items-center bg-slate-50 rounded-xl px-4 py-2 border border-slate-200 focus-within:border-brand focus-within:ring-1 focus-within:ring-brand transition">
                <input id="new-comment-content" class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-1 placeholder:text-slate-400" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." />
                <button id="btn-create-comment" class="text-brand font-bold text-sm px-3 py-1 hover:bg-indigo-50 rounded-lg transition disabled:opacity-50">ë“±ë¡</button>
            </div>
        </div>
    </aside>
</div>

<!-- ================= MYPAGE MODAL ================= -->
<div id="mypage-modal" class="fixed inset-0 z-[35] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" id="mypage-backdrop"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-5 space-y-4 z-10">
        <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg text-slate-900">ë§ˆì´í˜ì´ì§€</h3>
            <button id="mypage-close" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition">âœ•</button>
        </div>
        <div class="border border-slate-100 rounded-xl px-4 py-3 bg-slate-50 flex items-center gap-3">
            <div class="h-9 w-9 rounded-full bg-slate-200 flex items-center justify-center font-bold text-sm text-slate-700" id="mypage-avatar">U</div>
            <div>
                <div id="mypage-username" class="font-bold text-slate-900 text-sm">ë‚´ ê³„ì •</div>
                <div id="mypage-userid" class="text-[11px] text-slate-400">ID -</div>
            </div>
        </div>
        <div class="space-y-2">
            <button id="btn-my-posts" class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-slate-100 bg-white hover:bg-slate-50 transition text-sm">
                <span>ë‚´ ê²Œì‹œê¸€ ë³´ê¸°</span><span class="text-xs text-slate-400">Posts</span>
            </button>
            <button id="btn-my-comments" class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-slate-100 bg-white hover:bg-slate-50 transition text-sm">
                <span>ë‚´ ëŒ“ê¸€ ë³´ê¸°</span><span class="text-xs text-slate-400">Comments</span>
            </button>
            <button id="btn-my-followers" class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-slate-100 bg-white hover:bg-slate-50 transition text-sm">
                <span>ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒ</span><span class="text-xs text-slate-400">Followers</span>
            </button>
            <button id="btn-my-followings" class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-slate-100 bg-white hover:bg-slate-50 transition text-sm">
                <span>ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒ</span><span class="text-xs text-slate-400">Followings</span>
            </button>
        </div>
    </div>
</div>

<!-- ================= MY COMMENTS MODAL ================= -->
<div id="mycomments-modal" class="fixed inset-0 z-[38] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" id="mycomments-backdrop"></div>
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg z-50 overflow-hidden flex flex-col max-h-[80vh]">
        <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
            <h3 class="font-bold text-lg text-slate-800">ë‚´ ëŒ“ê¸€</h3>
            <button id="mycomments-close" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition">âœ•</button>
        </div>
        <div id="mycomments-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
        <div class="p-3 border-t border-slate-100 text-center bg-white">
            <button id="btn-mycomments-more" class="hidden text-sm text-brand font-bold py-2 w-full hover:bg-slate-50 rounded-xl transition">ë” ë³´ê¸°</button>
        </div>
    </div>
</div>

<!-- ================= USER LIST MODAL ================= -->
<div id="user-modal" class="fixed inset-0 z-[40] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" id="user-modal-backdrop"></div>
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm z-50 overflow-hidden flex flex-col max-h-[70vh]">
        <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
            <h3 id="user-modal-title" class="font-bold text-lg text-slate-800">íƒ€ì´í‹€</h3>
            <button id="user-modal-close" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition">âœ•</button>
        </div>
        <div id="user-modal-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
        <div class="p-3 border-t border-slate-100 text-center bg-white">
            <button id="btn-user-modal-more" class="hidden text-sm text-brand font-bold py-2 w-full hover:bg-slate-50 rounded-xl transition">ë” ë³´ê¸°</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl text-sm font-medium opacity-0 pointer-events-none transition-all duration-300 transform translate-y-4 z-[60]">
    ì•Œë¦¼ ë©”ì‹œì§€
</div>

<script>
    // ================= CONFIG & HELPERS =================
    const API_BASE = '';
    let accessToken = localStorage.getItem('accessToken') || null;
    let currentUserId = null;
    let currentUserProfile = null;

    let feedPage = 0, feedIsLast = false, isLoadingFeed = false, feedList = [];
    let feedFilterMemberId = null;
    let currentPost = null, commentPage = 0, commentIsLast = false, commentList = [];
    let userModalEndpoint = '', userModalPage = 0, userModalIsLast = false;
    let myCommentsPage = 0, myCommentsIsLast = false;

    const qs = (sel) => document.querySelector(sel);
    function showToast(msg) {
        const t = qs('#toast');
        t.textContent = msg;
        t.classList.remove('opacity-0', 'translate-y-4');
        setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 2500);
    }
    function timeAgo(dateString) {
        const date = new Date(dateString);
        const diff = (new Date() - date) / 1000;
        if (diff < 60) return 'ë°©ê¸ˆ ì „';
        if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
        return date.toLocaleDateString();
    }
    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    function decodeUserIdFromToken(token) {
        try {
            const payload = token.split('.')[1];
            const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
            const json = atob(base64);
            const obj = JSON.parse(json);
            return obj.sub ? Number(obj.sub) : null;
        } catch (e) { return null; }
    }
    function openAuth() { qs('#auth-screen').classList.remove('hidden'); }
    function closeAuth() { qs('#auth-screen').classList.add('hidden'); }
    function requireAuth() {
        if (!accessToken) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.'); openAuth(); return false; }
        return true;
    }

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (íŒ”ë¡œìš°/íŒ”ë¡œì‰)
    function setFollowButtonState(btn, following) {
        if (!btn) return;
        if (following) {
            btn.dataset.following = 'true'; btn.textContent = 'íŒ”ë¡œì‰';
            btn.className = 'text-[11px] font-bold bg-indigo-50 text-brand px-2 py-1 rounded-full hover:bg-indigo-100 transition btn-follow';
        } else {
            btn.dataset.following = 'false'; btn.textContent = 'íŒ”ë¡œìš°';
            btn.className = 'text-[11px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full hover:bg-slate-200 hover:text-slate-700 transition btn-follow';
        }
    }

    // ================= API =================
    async function api(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json' };
        if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
        const config = { method: options.method || 'GET', headers: { ...headers, ...options.headers } };
        if (options.body) config.body = JSON.stringify(options.body);

        const res = await fetch(`${API_BASE}${endpoint}`, config);
        const status = res.status;
        if (status === 401) {
            localStorage.removeItem('accessToken');
            accessToken = null;
            const err = new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); err.status = 401; throw err;
        }
        if (status === 204) return null;
        const text = await res.text();
        const data = text ? JSON.parse(text) : {};
        if (!res.ok) {
            const err = new Error(data.error_message || 'ìš”ì²­ ì‹¤íŒ¨'); err.status = status; throw err;
        }
        return data;
    }

    // ================= AUTH =================
    function toggleAuthMode() { qs('#login-form').classList.toggle('hidden'); qs('#signup-form').classList.toggle('hidden'); }
    async function initCurrentUser() {
        currentUserId = null; currentUserProfile = null;
        if (!accessToken) return;
        try {
            const uid = decodeUserIdFromToken(accessToken);
            if (!uid) { logout(); return; }
            currentUserId = uid;
            currentUserProfile = await api(`/members/${currentUserId}`);
        } catch (e) {}
    }
    function checkAuth() {
        if (accessToken && currentUserId) {
            qs('#btn-login-open').classList.add('hidden');
            qs('#btn-logout').classList.remove('hidden');
            qs('#btn-mypage').classList.remove('hidden');
            const name = currentUserProfile?.nickname || 'User';
            qs('#mypage-username').textContent = name;
            qs('#mypage-avatar').textContent = name.charAt(0).toUpperCase();
            qs('#mypage-userid').textContent = `ID ${currentUserId}`;
        } else {
            qs('#btn-login-open').classList.remove('hidden');
            qs('#btn-logout').classList.add('hidden');
            qs('#btn-mypage').classList.add('hidden');
        }
        qs('#app-screen').classList.remove('hidden');
        loadFeed(true);
    }
    async function login() {
        const email = qs('#login-email').value; const password = qs('#login-pw').value;
        if (!email || !password) return;
        try {
            const res = await api('/auth/login', { method: 'POST', body: { email, password } });
            accessToken = res.data; localStorage.setItem('accessToken', accessToken);
            qs('#login-email').value = ''; qs('#login-pw').value = '';
            await initCurrentUser(); closeAuth(); showToast('ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); checkAuth();
        } catch (e) { qs('#auth-msg').textContent = e.message; }
    }
    async function signup() {
        const nickname = qs('#signup-nick').value; const email = qs('#signup-email').value; const password = qs('#signup-pw').value;
        try {
            await api('/members', { method: 'POST', body: { nickname, email, password } });
            alert('ê°€ì… ì„±ê³µ!'); toggleAuthMode();
        } catch (e) { qs('#auth-msg').textContent = e.message; }
    }
    async function logout() {
        try {
            // refresh_tokenì€ ì¿ í‚¤ì— ìˆìœ¼ë‹ˆê¹Œ, ê°™ì€ ë„ë©”ì¸ì´ë¼ë©´ ê·¸ëƒ¥ í˜¸ì¶œë§Œ í•˜ë©´ ë¨
            await fetch('/auth/logout', {
                method: 'GET',
                credentials: 'include', // CORSë‚˜ ì„œë¸Œë„ë©”ì¸ ì“´ë‹¤ë©´ í•„ìˆ˜
            });
        } catch (e) {
            console.error('logout error', e);
        } finally {
            // ì„œë²„ ìª½ ì²˜ë¦¬ì™€ ìƒê´€ì—†ì´ í´ë¼ì´ì–¸íŠ¸ í† í°ì€ ë¬´ì¡°ê±´ ì§€ì›€
            localStorage.removeItem('accessToken');
            accessToken = null;
            window.location.reload();
        }
    }


    // ================= FEED =================
    async function loadFeed(reset = false) {
        if (isLoadingFeed) return;
        if (reset) { feedPage = 0; feedIsLast = false; feedList = []; qs('#feed-container').innerHTML = ''; qs('#feed-end').classList.add('hidden'); }
        if (feedIsLast) return;

        isLoadingFeed = true;
        qs('#feed-loading').classList.remove('hidden');
        try {
            let url = `/posts?page=${feedPage}&size=10`;
            if (feedFilterMemberId) url += `&memberId=${feedFilterMemberId}`;
            const res = await api(url);
            const newPosts = res.content || [];
            feedList = [...feedList, ...newPosts];
            feedIsLast = res.last;
            feedPage++;
            renderFeed(newPosts);
            if (feedIsLast) qs('#feed-end').classList.remove('hidden');
        } catch (e) { console.error(e); showToast('í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨'); }
        finally { isLoadingFeed = false; qs('#feed-loading').classList.add('hidden'); }
    }

    function renderFeed(posts) {
        const container = qs('#feed-container');
        posts.forEach(post => {
            const el = document.createElement('article');
            el.className = 'bg-white rounded-2xl border border-slate-200 p-5 hover:shadow-lg transition-all duration-200';

            const isMe = currentUserId && post.user_id === currentUserId;
            const followButtonHtml = !isMe
                ? `<button class="text-[11px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full hover:bg-slate-200 hover:text-slate-700 transition btn-follow" data-uid="${post.user_id}" data-following="false">íŒ”ë¡œìš°</button>`
                : '';
            const deleteBtnHtml = isMe
                ? `<button class="text-slate-300 hover:text-rose-500 ml-auto transition btn-delete-post" title="ì‚­ì œ">âœ•</button>`
                : '';

            el.innerHTML = `
                <div class="flex items-start mb-3">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-indigo-100 to-white border border-indigo-50 flex items-center justify-center font-bold text-brand shadow-sm">
                            ${post.user_name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-900">${post.user_name}</span>
                                ${followButtonHtml}
                            </div>
                            <div class="text-xs text-slate-400 font-medium">${timeAgo(post.created_at)}</div>
                        </div>
                    </div>
                    ${deleteBtnHtml}
                </div>
                <div class="text-slate-800 whitespace-pre-wrap leading-relaxed cursor-pointer post-content text-[15px] mb-4" data-id="${post.id}">${escapeHtml(post.content)}</div>
                <div class="flex items-center gap-6 border-t border-slate-100 pt-3">
                    <div class="flex items-center gap-1.5 group">
                        <button class="p-1.5 -ml-2 rounded-full text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition btn-like" data-id="${post.id}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        </button>
                        <button class="text-sm font-medium text-slate-500 hover:text-slate-800 hover:underline transition btn-view-likes" data-id="${post.id}">
                            ì¢‹ì•„ìš” <span class="like-count font-bold">${post.like_count}</span>ê°œ
                        </button>
                    </div>
                    <button class="flex items-center gap-1.5 group btn-comment" data-id="${post.id}">
                        <div class="p-1.5 rounded-full text-slate-400 group-hover:text-brand group-hover:bg-indigo-50 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </div>
                        <span class="text-sm font-medium text-slate-500 group-hover:text-brand transition">${post.comments}</span>
                    </button>
                </div>
            `;
            el.querySelector('.post-content').onclick = () => openDrawer(post.id);
            el.querySelector('.btn-comment').onclick = () => openDrawer(post.id);
            el.querySelector('.btn-like').onclick = (e) => toggleLikePost(post.id, e.currentTarget);
            const fb = el.querySelector('.btn-follow');
            if (fb) fb.onclick = (e) => toggleFollow(post.user_id, e.target);
            el.querySelector('.btn-view-likes').onclick = () => openUserModal(`/posts/${post.id}/likes`, 'ì´ í¬ìŠ¤íŠ¸ë¥¼ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒë“¤');
            const db = el.querySelector('.btn-delete-post');
            if(db) db.onclick = () => deletePost(post.id, el);

            container.appendChild(el);
        });
    }

    // ================= ACTIONS =================
    async function createPost() {
        if (!requireAuth()) return;
        const content = qs('#new-post-content').value.trim();
        if (!content) return showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        try {
            await api('/posts', { method: 'POST', body: { content } });
            qs('#new-post-content').value = ''; showToast('ê²Œì‹œ ì™„ë£Œ âœ¨'); loadFeed(true);
        } catch (e) { showToast(e.message); }
    }

    async function deletePost(id, el) {
        if (!confirm("ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            await api(`/posts/${id}`, { method: 'DELETE' });
            el.remove();
            showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { showToast("ì‚­ì œ ì‹¤íŒ¨ (ê¶Œí•œì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ)"); }
    }

    async function toggleLikePost(id, btnEl) {
        if (!requireAuth()) return;
        const countSpan = btnEl.parentElement.querySelector('.like-count');
        let currentCount = parseInt(countSpan.textContent);
        const icon = btnEl.querySelector('svg');
        try {
            try {
                await api(`/posts/${id}/likes`, { method: 'POST' });
                countSpan.textContent = currentCount + 1; icon.setAttribute('fill', 'currentColor'); btnEl.classList.add('text-rose-500');
            } catch (e) {
                await api(`/posts/${id}/likes`, { method: 'DELETE' });
                countSpan.textContent = Math.max(0, currentCount - 1); icon.setAttribute('fill', 'none'); btnEl.classList.remove('text-rose-500');
            }
        } catch (e) { console.error(e); }
    }

    // â˜… íŒ”ë¡œìš° í† ê¸€ í•µì‹¬ ë¡œì§ (íŒ”ë¡œìš° â†” ì–¸íŒ”ë¡œìš°) â˜…
    async function toggleFollow(targetId, btn) {
        if (!requireAuth()) return;
        btn.disabled = true;
        const isFollowing = btn.dataset.following === 'true'; // í˜„ì¬ ìƒíƒœ í™•ì¸
        try {
            if (!isFollowing) {
                // íŒ”ë¡œìš° ì‹¤í–‰ (POST)
                await api(`/members/${targetId}/follower`, { method: 'POST' });
                setFollowButtonState(btn, true);
                showToast('íŒ”ë¡œìš° í–ˆìŠµë‹ˆë‹¤.');
            } else {
                // ì–¸íŒ”ë¡œìš° ì‹¤í–‰ (DELETE)
                await api(`/members/${targetId}/follower`, { method: 'DELETE' });
                setFollowButtonState(btn, false);
                showToast('ì–¸íŒ”ë¡œìš° í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            // 409: ì´ë¯¸ íŒ”ë¡œìš° ì¤‘ì„ -> UIë¥¼ íŒ”ë¡œì‰ìœ¼ë¡œ ë³€ê²½
            if (e.status === 409) { setFollowButtonState(btn, true); showToast('ì´ë¯¸ íŒ”ë¡œìš° ì¤‘ì…ë‹ˆë‹¤.'); }
            // 404: íŒ”ë¡œìš° ê´€ê³„ê°€ ì—†ìŒ -> UIë¥¼ íŒ”ë¡œìš°ë¡œ ë³€ê²½
            else if (e.status === 404 && isFollowing) { setFollowButtonState(btn, false); }
            else if (e.status === 401) { openAuth(); showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); }
            else { showToast('ìš”ì²­ ì‹¤íŒ¨'); }
        } finally { btn.disabled = false; }
    }

    // ================= DRAWER =================
    async function openDrawer(postId) {
        qs('#drawer').classList.remove('hidden'); document.body.style.overflow = 'hidden';
        let post = feedList.find(p => p.id === postId);
        if (!post) { try { post = await api(`/posts/${postId}`); } catch (e) { return closeDrawer(); } }
        currentPost = post; renderDrawerPost(post); loadComments(true);
    }
    function closeDrawer() { qs('#drawer').classList.add('hidden'); document.body.style.overflow = ''; currentPost = null; }

    function renderDrawerPost(post) {
        const isMe = currentUserId && post.user_id === currentUserId;
        const followBtnHtml = !isMe
            ? `<button class="text-xs font-bold text-brand bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition btn-follow-drawer" data-uid="${post.user_id}">íŒ”ë¡œìš°</button>`
            : '';
        const deleteBtnHtml = isMe
            ? `<button class="text-slate-400 hover:text-rose-500 transition ml-2 btn-delete-drawer">âœ•</button>`
            : '';

        qs('#drawer-post').innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600">${post.user_name.charAt(0).toUpperCase()}</div>
                    <div>
                        <div class="font-bold text-slate-900">${post.user_name}</div>
                        <div class="text-xs text-slate-500">${timeAgo(post.created_at)}</div>
                    </div>
                </div>
                <div class="flex items-center">${followBtnHtml}${deleteBtnHtml}</div>
            </div>
            <div class="text-[16px] leading-relaxed whitespace-pre-wrap text-slate-800 mt-3">${escapeHtml(post.content)}</div>
            <div class="text-sm font-medium mt-3">
                <button class="text-slate-500 hover:text-slate-800 hover:underline transition" id="drawer-likes-btn">ì¢‹ì•„ìš” <span class="text-slate-900 font-bold">${post.like_count}</span>ê°œ</button>
            </div>
        `;
        qs('#drawer-comment-count').textContent = post.comments || 0;
        qs('#drawer-likes-btn').onclick = () => openUserModal(`/posts/${post.id}/likes`, 'ì´ í¬ìŠ¤íŠ¸ë¥¼ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒë“¤');

        const fb = qs('.btn-follow-drawer');
        if (fb) { setFollowButtonState(fb, false); fb.onclick = (e) => toggleFollow(post.user_id, e.target); }
        const db = qs('.btn-delete-drawer');
        if (db) {
            db.onclick = async () => {
                if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                try {
                    await api(`/posts/${post.id}`, { method: 'DELETE' });
                    closeDrawer(); showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadFeed(true);
                } catch(e) { showToast("ì‚­ì œ ì‹¤íŒ¨"); }
            };
        }
    }

    // ================= COMMENTS =================
    async function loadComments(reset = false) {
        if (!currentPost) return;
        if (reset) { commentPage = 0; commentIsLast = false; commentList = []; qs('#comments-list').innerHTML = ''; qs('#btn-load-more-comments').classList.add('hidden'); }
        if (commentIsLast) return;
        try {
            const res = await api(`/posts/${currentPost.id}/comments?page=${commentPage}&size=10`);
            const newComments = res.content || [];
            commentList = [...commentList, ...newComments];
            commentIsLast = res.last; commentPage++;
            newComments.forEach(c => {
                const el = document.createElement('div');
                el.className = 'flex gap-3 text-sm animate-fade-in';
                const isMyComment = currentUserId && c.user_id === currentUserId;
                const delBtnHtml = isMyComment ? `<button class="ml-auto text-rose-400 hover:text-rose-600 btn-del-comment">ì‚­ì œ</button>` : '';

                el.innerHTML = `
                    <div class="h-8 w-8 rounded-full bg-slate-100 shrink-0 flex items-center justify-center font-bold text-xs text-slate-500">${c.user_name.charAt(0)}</div>
                    <div class="flex-1">
                        <div class="bg-slate-50 p-3 rounded-2xl rounded-tl-none border border-slate-100/50">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-slate-900">${c.user_name}</span>
                                <span class="text-xs text-slate-400">${timeAgo(c.created_at)}</span>
                            </div>
                            <p class="whitespace-pre-wrap text-slate-700 leading-relaxed">${escapeHtml(c.content)}</p>
                        </div>
                        <div class="mt-1.5 flex gap-3 text-xs text-slate-500 font-medium pl-1">
                             <button class="hover:text-brand transition btn-like-comment">ì¢‹ì•„ìš” ${c.like_count}</button>
                             <button class="hover:text-slate-800 underline decoration-slate-300 btn-view-likes">ë³´ê¸°</button>
                             ${delBtnHtml}
                        </div>
                    </div>
                `;
                el.querySelector('.btn-like-comment').onclick = () => toggleLikeComment(c.id);
                el.querySelector('.btn-view-likes').onclick = () => openUserModal(`/comments/${c.id}/likes`, 'ëŒ“ê¸€ì„ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒë“¤');
                if(isMyComment) el.querySelector('.btn-del-comment').onclick = () => deleteComment(c.id, el);
                qs('#comments-list').appendChild(el);
            });
            if (!commentIsLast) qs('#btn-load-more-comments').classList.remove('hidden');
        } catch (e) { console.error(e); }
    }
    async function createComment() {
        if (!requireAuth()) return;
        const content = qs('#new-comment-content').value.trim();
        if (!content || !currentPost) return;
        try { await api('/comments', { method: 'POST', body: { post_id: currentPost.id, content } }); qs('#new-comment-content').value = ''; loadComments(true); } catch (e) { showToast(e.message); }
    }
    async function toggleLikeComment(id) {
        if (!requireAuth()) return;
        try { try { await api(`/comments/${id}/likes`, { method: 'POST' }); showToast('ëŒ“ê¸€ ì¢‹ì•„ìš”'); } catch { await api(`/comments/${id}/likes`, { method: 'DELETE' }); showToast('ëŒ“ê¸€ ì¢‹ì•„ìš” ì·¨ì†Œ'); } loadComments(true); } catch (e) {}
    }
    async function deleteComment(id, el) {
        if (!requireAuth()) return;
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try { await api(`/comments/${id}`, { method: 'DELETE' }); el.remove(); } catch (e) { showToast('ì‚­ì œ ì‹¤íŒ¨'); }
    }

    // ================= USER MODAL =================
    function openUserModal(endpoint, title) {
        if (!requireAuth()) return;
        userModalEndpoint = endpoint; userModalPage = 0; userModalIsLast = false;
        qs('#user-modal-title').textContent = title; qs('#user-modal-list').innerHTML = '';
        qs('#user-modal').classList.remove('hidden'); qs('#btn-user-modal-more').classList.add('hidden');
        loadUserModalItems();
    }
    function closeUserModal() { qs('#user-modal').classList.add('hidden'); }
    async function loadUserModalItems() {
        if (userModalIsLast) return;
        try {
            const res = await api(`${userModalEndpoint}?page=${userModalPage}&size=10`);
            const users = res.content || [];
            userModalIsLast = res.last; userModalPage++;
            const listEl = qs('#user-modal-list');
            if (users.length === 0 && userModalPage === 1) { listEl.innerHTML = '<div class="text-center text-slate-400 py-6 text-sm">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

            // "ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” ëª©ë¡"ì¸ì§€ í™•ì¸ (endpointì— /followingì´ í¬í•¨ë˜ê³  ë‚´ IDê°€ í¬í•¨ë¨)
            const isMyFollowingList = userModalEndpoint.includes(`/following`) && userModalEndpoint.includes(String(currentUserId));

            users.forEach(u => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-3 hover:bg-slate-50 rounded-xl transition';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-9 w-9 rounded-full bg-slate-200 flex items-center justify-center font-bold text-sm text-slate-600">${u.nickname.charAt(0)}</div>
                        <span class="font-bold text-slate-800 text-sm">${u.nickname}</span>
                    </div>
                    <button class="text-xs font-bold bg-slate-100 text-slate-500 px-3 py-1.5 rounded-lg hover:bg-slate-200 hover:text-slate-700 transition btn-follow" data-uid="${u.id}" data-following="false">íŒ”ë¡œìš°</button>
                `;
                const fb = row.querySelector('.btn-follow');
                if (currentUserId && u.id === currentUserId) fb.classList.add('hidden');
                else {
                    // â˜… í•µì‹¬: ë‚´ íŒ”ë¡œì‰ ëª©ë¡ì´ë©´ ë²„íŠ¼ ìƒíƒœë¥¼ 'íŒ”ë¡œì‰(Following)'ìœ¼ë¡œ ì´ˆê¸°í™”í•´ì„œ ë°”ë¡œ ì–¸íŒ”ë¡œìš° ê°€ëŠ¥í•˜ê²Œ í•¨
                    setFollowButtonState(fb, isMyFollowingList);
                    fb.onclick = (e) => toggleFollow(u.id, e.target);
                }
                listEl.appendChild(row);
            });
            if (!userModalIsLast) qs('#btn-user-modal-more').classList.remove('hidden'); else qs('#btn-user-modal-more').classList.add('hidden');
        } catch (e) { showToast('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨'); }
    }

    // ================= MYPAGE =================
    function openMypage() { if (!requireAuth() || !currentUserId) return; qs('#mypage-modal').classList.remove('hidden'); }
    function closeMypage() { qs('#mypage-modal').classList.add('hidden'); }
    function showMyPosts() { if (!currentUserId) return; feedFilterMemberId = currentUserId; closeMypage(); showToast('ë‚´ ê²Œì‹œê¸€ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.'); loadFeed(true); }
    function resetFeedFilter() { feedFilterMemberId = null; showToast('ì „ì²´ í”¼ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.'); loadFeed(true); }
    function openMyCommentsModal() { if (!requireAuth() || !currentUserId) return; qs('#mycomments-modal').classList.remove('hidden'); qs('#mycomments-list').innerHTML = ''; myCommentsPage = 0; myCommentsIsLast = false; loadMyComments(); }
    function closeMyCommentsModal() { qs('#mycomments-modal').classList.add('hidden'); }
    async function loadMyComments() {
        if (myCommentsIsLast || !currentUserId) return;
        try {
            const res = await api(`/comments?memberId=${currentUserId}&page=${myCommentsPage}&size=10`);
            const content = res.content || [];
            myCommentsIsLast = res.last; myCommentsPage++;
            const listEl = qs('#mycomments-list');
            if (content.length === 0 && myCommentsPage === 1) { listEl.innerHTML = '<div class="text-center text-slate-400 py-6 text-sm">ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            content.forEach(c => {
                const item = document.createElement('div');
                item.className = 'border border-slate-100 rounded-xl p-3 bg-slate-50';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-slate-400">ê²Œì‹œê¸€ #${c.post_id}</span>
                        <span class="text-xs text-slate-400">${timeAgo(c.created_at)}</span>
                    </div>
                    <p class="text-sm text-slate-800 whitespace-pre-wrap mb-2">${escapeHtml(c.content)}</p>
                    <button class="text-xs font-bold text-brand hover:underline">í•´ë‹¹ ê¸€ ë³´ê¸°</button>
                `;
                item.querySelector('button').onclick = () => { closeMyCommentsModal(); openDrawer(c.post_id); };
                listEl.appendChild(item);
            });
            if (!myCommentsIsLast) qs('#btn-mycomments-more').classList.remove('hidden'); else qs('#btn-mycomments-more').classList.add('hidden');
        } catch (e) { showToast('ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨'); }
    }

    // ================= EVENTS & INIT =================
    qs('#btn-login').onclick = login; qs('#btn-signup').onclick = signup; qs('#btn-logout').onclick = logout;
    qs('#btn-create-post').onclick = createPost; qs('#btn-create-comment').onclick = createComment;
    qs('#drawer-close').onclick = closeDrawer; qs('#drawer-backdrop').onclick = closeDrawer;
    qs('#btn-load-more-comments').onclick = () => loadComments(false);
    qs('#user-modal-close').onclick = closeUserModal; qs('#user-modal-backdrop').onclick = closeUserModal; qs('#btn-user-modal-more').onclick = loadUserModalItems;
    qs('#btn-login-open').onclick = openAuth; qs('#btn-mypage').onclick = openMypage; qs('#btn-feed-all').onclick = resetFeedFilter;
    qs('#mypage-close').onclick = closeMypage; qs('#mypage-backdrop').onclick = closeMypage;
    qs('#btn-my-posts').onclick = showMyPosts; qs('#btn-my-comments').onclick = () => { closeMypage(); openMyCommentsModal(); };
    qs('#btn-my-followers').onclick = () => { if (!currentUserId) return; closeMypage(); openUserModal(`/members/${currentUserId}/follower`, 'ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒë“¤'); };
    qs('#btn-my-followings').onclick = () => { if (!currentUserId) return; closeMypage(); openUserModal(`/members/${currentUserId}/following`, 'ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒë“¤'); };
    qs('#mycomments-close').onclick = closeMyCommentsModal; qs('#mycomments-backdrop').onclick = closeMyCommentsModal; qs('#btn-mycomments-more').onclick = loadMyComments;
    qs('#new-post-content').onfocus = () => { if (!accessToken) { qs('#new-post-content').blur(); requireAuth(); } };
    window.addEventListener('scroll', () => { if (!qs('#app-screen').classList.contains('hidden')) { if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) loadFeed(); } });

    async function initApp() { if (accessToken) await initCurrentUser(); checkAuth(); }
    initApp();
</script>
</body>
</html>